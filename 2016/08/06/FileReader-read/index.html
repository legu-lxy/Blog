<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="http://fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="Java,"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1"><meta name="description" content="前言今天看到这么一个问题：FileReader是如何读取一个中文的,烦请大神分析一下?，于是写篇文章来分析一下 0.0

本回答仅对 Oracle JDK 1.8.0 负责。"><meta property="og:type" content="article"><meta property="og:title" content="FileReader 是如何读取中文的？"><meta property="og:url" content="http://blog.cat73.org/2016/08/06/FileReader-read/index.html"><meta property="og:site_name" content="Cat73 Blog"><meta property="og:description" content="前言今天看到这么一个问题：FileReader是如何读取一个中文的,烦请大神分析一下?，于是写篇文章来分析一下 0.0

本回答仅对 Oracle JDK 1.8.0 负责。"><meta property="og:updated_time" content="2016-08-06T14:21:46.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="FileReader 是如何读取中文的？"><meta name="twitter:description" content="前言今天看到这么一个问题：FileReader是如何读取一个中文的,烦请大神分析一下?，于是写篇文章来分析一下 0.0

本回答仅对 Oracle JDK 1.8.0 负责。"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:8181698,author:"Cat73"}}</script><link rel="canonical" href="http://blog.cat73.org/2016/08/06/FileReader-read/"><title> FileReader 是如何读取中文的？ | Cat73 Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Cat73 Blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">喵星人占领地球战略指挥部</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> FileReader 是如何读取中文的？</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2016-08-06T19:57:41+08:00" content="2016-08-06">2016-08-06</time></span> <span class="post-category">&nbsp; | &nbsp;<span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2016/08/06/FileReader-read/#comments" itemprop="discussionUrl"><span class="post-comments-count ds-thread-count" data-thread-key="2016/08/06/FileReader-read/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天看到这么一个问题：<code>FileReader是如何读取一个中文的,烦请大神分析一下?</code>，于是写篇文章来分析一下 0.0</p><blockquote><p>本回答仅对 Oracle JDK 1.8.0 负责。</p></blockquote><a id="more"></a><h2 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h2><p>首先看一下<code>FileReader</code>的源代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.io.FileReader.java (已省略文档注释)</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileReader</span> <span class="keyword">extends</span> <span class="title">InputStreamReader</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileReader</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> FileInputStream(fileName));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileReader</span><span class="params">(File file)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> FileInputStream(file));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileReader</span><span class="params">(FileDescriptor fd)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> FileInputStream(fd));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>实际看一下<code>FileReader</code>的源代码就会发现，它其实只是简单的包装了一下<code>InputStreamReader</code>，简单的帮你将文件转换成了<code>FileInputStream</code>传递给了<code>InputStreamReader</code>。<br>而中文其实就是一个<code>char</code>，那么问题实际上就是：<em><code>InputStreamReader</code>是如何读取<code>char</code>的</em>。</p><p>让我们来看一下<code>InputStreamReader</code>的<code>read</code>是怎么做的(只有<code>char[]</code>参数的<code>read</code>方法其实是包装了这个方法)：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// int java.io.InputStreamReader.read(char, int, int)</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span> cbuf[], <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> sd.read(cbuf, offset, length);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>我们可以看到它只是对<code>sd.read</code>的包装，那么我们再来看看这个<code>sd</code>是个什么鬼：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// int java.io.InputStreamReader.java (已省略文档注释)</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> StreamDecoder sd;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InputStreamReader</span><span class="params">(InputStream in)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(in);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        sd = StreamDecoder.forInputStreamReader(in, <span class="keyword">this</span>, (String)<span class="keyword">null</span>); <span class="comment">// ## check lock object</span></div><div class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">        <span class="comment">// The default encoding should always be available</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>可以看到<code>sd</code>是<code>StreamDecoder</code>的实例，顺便贴了被<code>FileReader</code>调用的构造函数，可以看到就是在这里实例化了<code>sd</code>。<br>那么我们再去瞅瞅这个<code>StreamDecoder.read</code>，这货是<code>sun</code>包的，没有直接提供源码。<br>但我们不怕，可以反编译，也可以看<code>OpenJDK</code>的代码，为了方便看，这里选择了看<code>OpenJDK</code>的代码。</p><h2 id="StreamDecoder"><a href="#StreamDecoder" class="headerlink" title="StreamDecoder"></a>StreamDecoder</h2><p>首先来看看它的<code>read</code>方法：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span> cbuf[], <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// 创建两个临时变量，避免直接修改参数</span></div><div class="line">    <span class="keyword">int</span> off = offset;</div><div class="line">    <span class="keyword">int</span> len = length;</div><div class="line">    <span class="comment">// 加锁</span></div><div class="line">    <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">        <span class="comment">// 检查自己是否已开启，如果没有则抛出异常</span></div><div class="line">        ensureOpen();</div><div class="line">        <span class="comment">// 检查输出参数是否无效，无效则抛出异常</span></div><div class="line">        <span class="keyword">if</span> ((off &lt; <span class="number">0</span>) || (off &gt; cbuf.length) || (len &lt; <span class="number">0</span>) ||</div><div class="line">            ((off + len) &gt; cbuf.length) || ((off + len) &lt; <span class="number">0</span>)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果读取长度为 0，则直接返回 0</span></div><div class="line">        <span class="keyword">if</span> (len == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 如上次读取的 2 个 byte 不是双字节字符，则这个值会被设置为 1 来防止返回值计算错误</span></div><div class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 如上次读取的 2 个 byte 不是双字节字符</span></div><div class="line">        <span class="keyword">if</span> (haveLeftoverChar) &#123;</div><div class="line">            <span class="comment">// 将上次读取的两个 byte 的后面的一个保存到返回值数组的第一个位置</span></div><div class="line">            <span class="comment">// Copy the leftover char into the buffer</span></div><div class="line">            cbuf[off] = leftoverChar;</div><div class="line">            <span class="comment">// 因为已经读取了一个字符，所以起始地址增加 1，长度减少 1</span></div><div class="line">            off++; len--;</div><div class="line">            <span class="comment">// 因为已经用过了上次读取的两个 byte 中后面的一个，所以上次取消设置这个标志位</span></div><div class="line">            haveLeftoverChar = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// 已经读取了一个字符，将这个值设置为 1 来防止返回值计算错误</span></div><div class="line">            n = <span class="number">1</span>;</div><div class="line">            <span class="comment">// 如果还需读取的长度为 0，或尚未准备好读取，则直接返回已读长度(1)</span></div><div class="line">            <span class="keyword">if</span> ((len == <span class="number">0</span>) || !implReady())</div><div class="line">                <span class="comment">// Return now if this is all we can produce w/o blocking</span></div><div class="line">                <span class="keyword">return</span> n;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 如果还需读取的字符长度为 1</span></div><div class="line">        <span class="keyword">if</span> (len == <span class="number">1</span>) &#123;</div><div class="line">            <span class="comment">// 调用 read0 读取一个字符</span></div><div class="line">            <span class="comment">// Treat single-character array reads just like read()</span></div><div class="line">            <span class="keyword">int</span> c = read0();</div><div class="line">            <span class="comment">// 如果读取失败，则根据 n 的值确定返回失败还是 n</span></div><div class="line">            <span class="keyword">if</span> (c == -<span class="number">1</span>)</div><div class="line">                <span class="keyword">return</span> (n == <span class="number">0</span>) ? -<span class="number">1</span> : n;</div><div class="line">            <span class="comment">// 保存读取到的字符</span></div><div class="line">            cbuf[off] = (<span class="keyword">char</span>)c;</div><div class="line">            <span class="comment">// 返回读取长度</span></div><div class="line">            <span class="keyword">return</span> n + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 调用 implRead 来读取更多字符</span></div><div class="line">        <span class="keyword">return</span> n + implRead(cbuf, off, off + len);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>可以看到前面都是针对单个字符的处理，实际读取多个字符的是后面的<code>implRead</code>，而之前也有个<code>read0</code>可以读取一个字符。<br>查看源代码发现，<code>read0</code>实际上还是对<code>read</code>的包装，最后还是会调用到<code>implRead</code>，所以就不浪费时间了，直接看<code>implRead</code>吧：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">implRead</span><span class="params">(<span class="keyword">char</span>[] cbuf, <span class="keyword">int</span> off, <span class="keyword">int</span> end)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// 如果要读取的长度 &lt;= 0，则抛出异常</span></div><div class="line">    <span class="comment">// In order to handle surrogate pairs, this method requires that</span></div><div class="line">    <span class="comment">// the invoker attempt to read at least two characters.  Saving the</span></div><div class="line">    <span class="comment">// extra character, if any, at a higher level is easier than trying</span></div><div class="line">    <span class="comment">// to deal with it here.</span></div><div class="line">    <span class="keyword">assert</span> (end - off &gt; <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 创建保存结果的容器</span></div><div class="line">    CharBuffer cb = CharBuffer.wrap(cbuf, off, end - off);</div><div class="line">    <span class="keyword">if</span> (cb.position() != <span class="number">0</span>)</div><div class="line">        <span class="comment">// Ensure that cb[0] == cbuf[off]</span></div><div class="line">        cb = cb.slice();</div><div class="line"></div><div class="line">    <span class="comment">// 是否已经读到结尾的标志位</span></div><div class="line">    <span class="keyword">boolean</span> eof = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="comment">// 对缓冲区中的字符进行解码</span></div><div class="line">        CoderResult cr = decoder.decode(bb, cb, eof);</div><div class="line">        <span class="comment">// 如果没有更多的输入要处理</span></div><div class="line">        <span class="keyword">if</span> (cr.isUnderflow()) &#123;</div><div class="line">            <span class="comment">// 如果已经读到结尾则跳出循环</span></div><div class="line">            <span class="keyword">if</span> (eof)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">// 如果输出保存结果的容器已经没有剩余空间则跳出循环</span></div><div class="line">            <span class="keyword">if</span> (!cb.hasRemaining())</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">// 如果已经读了一些数据，且尚未准备好继续读取，则跳出循环</span></div><div class="line">            <span class="keyword">if</span> ((cb.position() &gt; <span class="number">0</span>) &amp;&amp; !inReady())</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">// Block at most once</span></div><div class="line">            <span class="comment">// 刷新输入缓冲区</span></div><div class="line">            <span class="keyword">int</span> n = readBytes();</div><div class="line">            <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</div><div class="line">                eof = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">if</span> ((cb.position() == <span class="number">0</span>) &amp;&amp; (!bb.hasRemaining()))</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                decoder.reset();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果输出缓冲区没有更多的空间则跳出循环</span></div><div class="line">        <span class="keyword">if</span> (cr.isOverflow()) &#123;</div><div class="line">            <span class="keyword">assert</span> cb.position() &gt; <span class="number">0</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        cr.throwException();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果已经读到结尾则重置解码器</span></div><div class="line">    <span class="keyword">if</span> (eof) &#123;</div><div class="line">        <span class="comment">// ## Need to flush decoder</span></div><div class="line">        decoder.reset();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果一个字也没读出来，则返回读取失败</span></div><div class="line">    <span class="keyword">if</span> (cb.position() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (eof)</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 返回读取长度</span></div><div class="line">    <span class="keyword">return</span> cb.position();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>可以看到，最关键的解码是由<code>decoder.decode</code>来完成的，那么这个<code>decoder</code>是啥呢，我们来瞅瞅：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> CharsetDecoder decoder;</div><div class="line"></div><div class="line">StreamDecoder(InputStream in, Object lock, Charset cs) &#123;</div><div class="line">    <span class="keyword">this</span>(in, lock, cs.newDecoder().onMalformedInput(CodingErrorAction.REPLACE).onUnmappableCharacter(CodingErrorAction.REPLACE));</div><div class="line">&#125;</div><div class="line"></div><div class="line">StreamDecoder(InputStream in, Object lock, CharsetDecoder dec) &#123;</div><div class="line">    <span class="keyword">super</span>(lock);</div><div class="line">    <span class="keyword">this</span>.cs = dec.charset();</div><div class="line">    <span class="keyword">this</span>.decoder = dec;</div><div class="line"></div><div class="line">    <span class="comment">// This path disabled until direct buffers are faster</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> &amp;&amp; in <span class="keyword">instanceof</span> FileInputStream) &#123;</div><div class="line">        ch = getChannel((FileInputStream)in);</div><div class="line">        <span class="keyword">if</span> (ch != <span class="keyword">null</span>)</div><div class="line">            bb = ByteBuffer.allocateDirect(DEFAULT_BYTE_BUFFER_SIZE);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (ch == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.in = in;</div><div class="line">        <span class="keyword">this</span>.ch = <span class="keyword">null</span>;</div><div class="line">        bb = ByteBuffer.allocate(DEFAULT_BYTE_BUFFER_SIZE);</div><div class="line">    &#125;</div><div class="line">    bb.flip();                      <span class="comment">// So that bb is initially empty</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>通过看源代码可以发现，这个东东是由构造函数去初始化的，回顾下<code>InputStreamReader</code>的构造函数，构造<code>StreamDecoder</code>的方法其实是这个：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sd = StreamDecoder.forInputStreamReader(in, <span class="keyword">this</span>, (String)<span class="keyword">null</span>);</div></pre></td></tr></table></figure><p>OK，来瞅瞅这个<code>forInputStreamReader</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StreamDecoder <span class="title">forInputStreamReader</span><span class="params">(InputStream in, Object lock, String charsetName)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</div><div class="line">    String csn = charsetName;</div><div class="line">    <span class="keyword">if</span> (csn == <span class="keyword">null</span>)</div><div class="line">        csn = Charset.defaultCharset().name();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (Charset.isSupported(csn))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StreamDecoder(in, lock, Charset.forName(csn));</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalCharsetNameException x) &#123; &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedEncodingException (csn);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><code>charsetName</code>参数传进来的就是<code>null</code>，所以实际会取<code>Charset.defaultCharset().name()</code>。<br>查看源码可知，这个默认编码可以通过启动参数修改，默认是<code>UTF-8</code>。<br>这里我就不再去分析<code>Charset.newDecoder</code>的做了什么了，直接拿一段简单的代码执行一下就知道了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Log.debugVals(Charset.defaultCharset().newDecoder().getClass());</div><div class="line"><span class="comment">// [00:00:00] [DEBUG]: [class sun.nio.cs.UTF_8$Decoder]</span></div></pre></td></tr></table></figure><p>OK，现在我们知道了，解码工作实际是由<code>sun.nio.cs.UTF_8$Decoder</code>来完成的。<br>这个类是个很长的类，里面实现了<code>UTF-8</code>的解码，这个就比较复杂了，我就不写了，有兴趣可以自己去瞅瞅：<br><a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/nio/cs/UTF_8.java#l81" target="_blank" rel="external">sun.nio.cs.UTF_8$Decoder</a></p><h2 id="链接-amp-参考"><a href="#链接-amp-参考" class="headerlink" title="链接 &amp; 参考"></a>链接 &amp; 参考</h2><ul><li><a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/nio/cs/StreamDecoder.java" target="_blank" rel="external">StreamDecoder.java</a></li></ul></div><div></div><div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/Java/" rel="tag">#Java</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2016/08/05/next-highlight-langs/" rel="next" title="NexT 自带的语法高亮插件支持的语言列表"><i class="fa fa-chevron-left"></i> NexT 自带的语法高亮插件支持的语言列表</a></div><div class="post-nav-prev post-nav-item"></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div class="ds-thread" data-thread-key="2016/08/06/FileReader-read/" data-title="FileReader 是如何读取中文的？" data-url="http://blog.cat73.org/2016/08/06/FileReader-read/"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars1.githubusercontent.com/u/9296576" alt="Cat73"><p class="site-author-name" itemprop="name">Cat73</p><p class="site-description motion-element" itemprop="description">大家好窝萌是来统治蓝星人和汪星人的喵星人</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">5</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories"><span class="site-state-item-count">3</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">5</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Cat7373" target="_blank" title="Github"><i class="fa fa-fw fa-globe"></i> Github</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://notes.jimliang.com/" title="Jim's Notes" target="_blank">Jim's Notes</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#初步分析"><span class="nav-number">2.</span> <span class="nav-text">初步分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StreamDecoder"><span class="nav-number">3.</span> <span class="nav-text">StreamDecoder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#链接-amp-参考"><span class="nav-number">4.</span> <span class="nav-text">链接 & 参考</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2016</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Cat73</span></div><div class="powered-by"> 由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">var duoshuoQuery={short_name:"cat7373"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.id="duoshuo-script",t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script><script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script><script src="/js/src/hook-duoshuo.js"></script></body></html>